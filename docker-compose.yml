services:
  postgres:
    image: postgres:16-alpine
    container_name: postgres
    restart: always
    environment:
      POSTGRES_USER: ${POSTGRES_USER}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
      POSTGRES_DB: ${POSTGRES_DB}
    ports:
      - "5432:5432"
    volumes:
      - pgdata:/var/lib/postgresql/data
      - /mnt/e/web_images:/web_images
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER} -d ${POSTGRES_DB}"]
      interval: 10s
      timeout: 5s
      retries: 10

  redis:
    image: redis/redis-stack-server:latest
    container_name: redis
    restart: always
    ports:
      - "6379:6379"
    volumes:
      - redis-data:/data
    environment:
      REDIS_ARGS: "--appendonly yes"
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5

  pgadmin:
    image: dpage/pgadmin4:latest
    container_name: pgadmin
    restart: always
    depends_on:
      postgres:
        condition: service_healthy
    environment:
      PGADMIN_DEFAULT_EMAIL: ${PGADMIN_DEFAULT_EMAIL}
      PGADMIN_DEFAULT_PASSWORD: ${PGADMIN_DEFAULT_PASSWORD}
    ports:
      - "5050:80"
    volumes:
      - pgadmin-data:/var/lib/pgadmin

  # n8n (your custom build with ImageMagick)
  n8n:
    build:
      context: .
      dockerfile: n8n.Dockerfile
    image: ${N8N_IMAGE_NAME}
    container_name: n8n
    restart: always
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    ports:
      - "5678:5678"
    healthcheck:
      test: ["CMD-SHELL", "wget --no-verbose --tries=1 --spider http://localhost:5678/healthz || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 12
      start_period: 30s
    environment:
      N8N_MCP_TELEMETRY_DISABLED: "true"
      # DB (Postgres)
      DB_TYPE: postgresdb
      DB_POSTGRESDB_HOST: postgres
      DB_POSTGRESDB_PORT: 5432
      DB_POSTGRESDB_DATABASE: ${POSTGRES_DB}
      DB_POSTGRESDB_USER: ${POSTGRES_USER}
      DB_POSTGRESDB_PASSWORD: ${POSTGRES_PASSWORD}

      # URLs / base config
      N8N_PROTOCOL: ${N8N_PROTOCOL}
      N8N_HOST: ${N8N_HOST}
      N8N_PORT: 5678
      WEBHOOK_URL: ${WEBHOOK_URL}
      N8N_EDITOR_BASE_URL: ${N8N_EDITOR_BASE_URL}
      GENERIC_TIMEZONE: ${GENERIC_TIMEZONE}

      # Auth
      N8N_BASIC_AUTH_ACTIVE: "true"
      N8N_BASIC_AUTH_USER: ${N8N_BASIC_AUTH_USER}
      N8N_BASIC_AUTH_PASSWORD: ${N8N_BASIC_AUTH_PASSWORD}

      # Memory / stability
      NODE_OPTIONS: ${NODE_OPTIONS}
      N8N_CONCURRENCY_PRODUCTION_LIMIT: ${N8N_CONCURRENCY_PRODUCTION_LIMIT}
      N8N_PUSH_BACKEND: ${N8N_PUSH_BACKEND}

      # Execution pruning
      EXECUTIONS_DATA_PRUNE: "true"
      EXECUTIONS_DATA_MAX_AGE: ${EXECUTIONS_DATA_MAX_AGE}
      EXECUTIONS_DATA_SAVE_ON_SUCCESS: ${EXECUTIONS_DATA_SAVE_ON_SUCCESS}
      EXECUTIONS_DATA_SAVE_ON_PROGRESS: ${EXECUTIONS_DATA_SAVE_ON_PROGRESS}

      # Newer config warnings you saw
      N8N_RUNNERS_ENABLED: ${N8N_RUNNERS_ENABLED}
      N8N_GIT_NODE_DISABLE_BARE_REPOS: ${N8N_GIT_NODE_DISABLE_BARE_REPOS}
      N8N_BLOCK_ENV_ACCESS_IN_NODE: ${N8N_BLOCK_ENV_ACCESS_IN_NODE}

      # Optional: keep the settings file perms warning quiet
      N8N_ENFORCE_SETTINGS_FILE_PERMISSIONS: "true"

      # Convenience service URLs
      OLLAMA_BASE_URL: http://ollama:11434
      QDRANT_URL: http://qdrant:6333
      REDIS_URL: redis://redis:6379
      SEARXNG_URL: http://searxng:8080
      WEB_IMAGES_DIR: /web_images
    volumes:
      - n8n-data:/home/node/.n8n
      - /mnt/e/web_images:/web_images

  qdrant:
    image: qdrant/qdrant:latest
    container_name: qdrant
    restart: always
    ports:
      - "6333:6333"
      - "6334:6334"
    volumes:
      - qdrant_storage:/qdrant/storage

  ollama:
    image: ollama/ollama:latest
    container_name: ollama
    restart: unless-stopped
    environment:
      OLLAMA_HOST: 0.0.0.0:11434
    ports:
      - "11434:11434"
    volumes:
      - ollama:/root/.ollama
      - /mnt/e/web_images:/web_images

  openwebui:
    image: ghcr.io/open-webui/open-webui:latest
    container_name: openwebui
    restart: unless-stopped
    depends_on:
      - ollama
      - searxng
    environment:
      OLLAMA_BASE_URL: http://ollama:11434
      SEARXNG_QUERY_URL: http://searxng:8080/search?q=<query>
      ENABLE_RAG_WEB_SEARCH: "true"
      RAG_WEB_SEARCH_ENGINE: searxng
      RAG_WEB_SEARCH_RESULT_COUNT: "5"
      RAG_WEB_SEARCH_CONCURRENT_REQUESTS: "10"
    ports:
      - "3000:8080"
    volumes:
      - openwebui-data:/app/backend/data

  # Optional: ImageMagick utility container
  imagemagick:
    image: dpokidov/imagemagick:latest
    container_name: imagemagick
    restart: unless-stopped
    volumes:
      - /mnt/e/web_images:/work
    working_dir: /work
    entrypoint: ["tail", "-f", "/dev/null"]

  # SearXNG metasearch engine
  searxng:
    image: searxng/searxng:latest
    container_name: searxng
    restart: always
    ports:
      - "8080:8080"
    environment:
      - SEARXNG_BASE_URL=http://localhost:8080/
      - SEARXNG_SECRET=${SEARXNG_SECRET:-}
      - SEARXNG_BIND_ADDRESS=0.0.0.0:8080
    cap_drop:
      - ALL
    cap_add:
      - CHOWN
      - SETGID
      - SETUID
      - DAC_OVERRIDE
    logging:
      driver: "json-file"
      options:
        max-size: "1m"
        max-file: "1"

  # n8n Documentation MCP Server
  n8n-docs-mcp:
    image: ghcr.io/czlonkowski/n8n-mcp:latest
    container_name: n8n-docs-mcp
    restart: unless-stopped
    depends_on:
      n8n:
        condition: service_healthy
    environment:
      N8N_API_URL: http://n8n:5678
      N8N_API_KEY: ${N8N_API_KEY:-}
      LOG_LEVEL: error
      DISABLE_CONSOLE_OUTPUT: "true"
    stdin_open: true
    tty: false

  # Playwright MCP Server (Browser Automation)
  playwright-mcp:
    image: mcp/playwright:latest
    container_name: playwright-mcp
    restart: unless-stopped
    stdin_open: true
    tty: false
    init: true

  # PostgreSQL MCP Server (Secure Alternative - Postgres MCP Pro)
  postgres-mcp:
    image: crystaldba/postgres-mcp:latest
    container_name: postgres-mcp
    restart: unless-stopped
    depends_on:
      postgres:
        condition: service_healthy
    environment:
      DATABASE_URI: postgresql://${POSTGRES_USER}:${POSTGRES_PASSWORD}@postgres:5432/${POSTGRES_DB}
    stdin_open: true
    tty: false
    command: ["--access-mode=restricted"]

volumes:
  pgdata:
  pgadmin-data:
  redis-data:
  n8n-data:
  qdrant_storage:
  ollama:
  openwebui-data:
